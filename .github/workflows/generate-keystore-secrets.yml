name: Generate Keystore and Secrets

on:
  workflow_dispatch:
    inputs:
      keystore_password:
        description: 'Keystore Password (mindestens 6 Zeichen)'
        required: true
        type: string
      key_password:
        description: 'Key Password (mindestens 6 Zeichen)'
        required: true
        type: string
      key_alias:
        description: 'Key Alias (Standard: fishit-mapper)'
        required: false
        default: 'fishit-mapper'
        type: string
      validity_days:
        description: 'G√ºltigkeit in Tagen (Standard: 10000 = ~27 Jahre)'
        required: false
        default: '10000'
        type: string
      dname:
        description: 'Distinguished Name (CN, OU, O, L, ST, C)'
        required: false
        default: 'CN=FishIT Mapper,OU=Development,O=FishIT,L=Unknown,ST=Unknown,C=DE'
        type: string

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Generate Keystore
        id: generate
        run: |
          # Tempor√§res Verzeichnis f√ºr Keystore
          mkdir -p /tmp/keystore
          
          # Keystore generieren
          keytool -genkeypair \
            -v \
            -keystore /tmp/keystore/release.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity ${{ inputs.validity_days }} \
            -alias ${{ inputs.key_alias }} \
            -storepass "${{ inputs.keystore_password }}" \
            -keypass "${{ inputs.key_password }}" \
            -dname "${{ inputs.dname }}"
          
          echo "‚úÖ Keystore erfolgreich generiert!"
          
          # Keystore-Informationen anzeigen
          echo ""
          echo "üìã Keystore-Informationen:"
          keytool -list -v -keystore /tmp/keystore/release.jks -storepass "${{ inputs.keystore_password }}"
          
          # Base64-Kodierung f√ºr GitHub Secrets
          KEYSTORE_BASE64=$(base64 -w 0 /tmp/keystore/release.jks)
          
          # Ausgabe der kodierten Daten (wird in Job-Log geschrieben)
          echo "keystore_base64<<EOF" >> $GITHUB_OUTPUT
          echo "$KEYSTORE_BASE64" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Keystore wurde Base64-kodiert"
      
      - name: Generate Setup Instructions
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          # üîê Keystore erfolgreich generiert!
          
          ## üìù N√§chste Schritte: GitHub Secrets konfigurieren
          
          Um die generierten Keystore-Daten als GitHub Secrets zu speichern, folgen Sie diesen Schritten:
          
          ### 1. Repository Settings √∂ffnen
          Gehen Sie zu: `Settings` ‚Üí `Secrets and variables` ‚Üí `Actions`
          
          ### 2. Folgende Secrets hinzuf√ºgen
          
          Klicken Sie auf `New repository secret` und f√ºgen Sie die folgenden Secrets hinzu:
          
          #### Secret 1: KEYSTORE_BASE64
          - **Name:** `KEYSTORE_BASE64`
          - **Value:** Kopieren Sie den Base64-kodierten Keystore aus dem Job-Log (siehe Output von "Generate Keystore")
            - ‚ö†Ô∏è Der komplette Base64-String aus dem Output `keystore_base64`
          
          #### Secret 2: KEYSTORE_PASSWORD
          - **Name:** `KEYSTORE_PASSWORD`
          - **Value:** `${{ inputs.keystore_password }}`
          
          #### Secret 3: KEY_ALIAS
          - **Name:** `KEY_ALIAS`
          - **Value:** `${{ inputs.key_alias }}`
          
          #### Secret 4: KEY_PASSWORD
          - **Name:** `KEY_PASSWORD`
          - **Value:** `${{ inputs.key_password }}`
          
          ### 3. Secrets verifizieren
          Nach dem Hinzuf√ºgen sollten Sie 4 neue Secrets sehen:
          - ‚úÖ KEYSTORE_BASE64
          - ‚úÖ KEYSTORE_PASSWORD
          - ‚úÖ KEY_ALIAS
          - ‚úÖ KEY_PASSWORD
          
          ### 4. Android Build Workflow testen
          Nach der Konfiguration k√∂nnen Sie den `Android Build` Workflow ausf√ºhren:
          - Der Workflow dekodiert automatisch den Keystore
          - Die App wird mit dem konfigurierten Signing Key signiert
          - Die signierte APK wird als Artifact hochgeladen
          
          ## üì± Verwendung
          
          ### CI/CD (GitHub Actions)
          Die Workflows `android-build.yml` und `build-app.yml` verwenden automatisch die konfigurierten Secrets zum Signieren der Release-Builds.
          
          ### Lokale Entwicklung (optional)
          Um den Keystore lokal zu verwenden:
          1. Laden Sie den Keystore aus dem Job-Artifact herunter
          2. Speichern Sie ihn unter `keystore/release.jks` im Repository-Root
          3. Der Build erkennt den lokalen Keystore automatisch (siehe `build.gradle.kts`)
          
          ‚ö†Ô∏è **WICHTIG:** Committen Sie den Keystore NIEMALS ins Git-Repository! Der `keystore/` Ordner ist bereits in `.gitignore` eingetragen.
          
          ## üîí Sicherheitshinweise
          
          - ‚ö†Ô∏è Behandeln Sie den Keystore und die Passw√∂rter vertraulich
          - ‚ö†Ô∏è Der Base64-kodierte Keystore ist im Job-Log sichtbar - l√∂schen Sie alte Workflow-Runs nach der Secret-Konfiguration
          - ‚ö†Ô∏è F√ºr Production-Apps: Verwenden Sie einen separaten, sicher gespeicherten Keystore
          - ‚úÖ Die Secrets sind in GitHub verschl√ºsselt gespeichert und nur f√ºr Workflows mit entsprechenden Berechtigungen zug√§nglich
          
          ## üìö Weitere Informationen
          
          - [Android App Signing Dokumentation](https://developer.android.com/studio/publish/app-signing)
          - [GitHub Secrets Dokumentation](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
          
          ---
          
          **Keystore-Details:**
          - Alias: `${{ inputs.key_alias }}`
          - G√ºltigkeit: `${{ inputs.validity_days }}` Tage
          - Algorithmus: RSA 2048-bit
          - Distinguished Name: `${{ inputs.dname }}`
          EOF
          
          echo ""
          echo "========================================="
          echo "üìã Setup-Anleitung wurde in der Job-Summary erstellt"
          echo "========================================="
      
      - name: Upload Keystore as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: keystore-release
          path: /tmp/keystore/release.jks
          retention-days: 7
          if-no-files-found: error
      
      - name: Display Base64 Encoded Keystore
        run: |
          echo "========================================="
          echo "üîê BASE64-KODIERTER KEYSTORE"
          echo "========================================="
          echo ""
          echo "Kopieren Sie den folgenden Base64-String und f√ºgen Sie ihn als GitHub Secret 'KEYSTORE_BASE64' hinzu:"
          echo ""
          base64 -w 0 /tmp/keystore/release.jks
          echo ""
          echo ""
          echo "========================================="
          echo "‚ö†Ô∏è  WICHTIG: Kopieren Sie diesen kompletten String (ohne Zeilenumbr√ºche) in das Secret KEYSTORE_BASE64"
          echo "========================================="
      
      - name: Cleanup
        if: always()
        run: |
          # Keystore aus tempor√§rem Verzeichnis l√∂schen
          rm -rf /tmp/keystore
          echo "‚úÖ Tempor√§re Dateien wurden gel√∂scht"
