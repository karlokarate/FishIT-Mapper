name: SonarQube Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      analyze_android:
        description: 'üì± Android App analysieren'
        type: boolean
        default: true
      analyze_contract:
        description: 'üìÑ Contract Module analysieren'
        type: boolean
        default: true
      analyze_engine:
        description: '‚öôÔ∏è Engine Module analysieren'
        type: boolean
        default: true
      analyze_codegen:
        description: 'üõ†Ô∏è Codegen Tools analysieren'
        type: boolean
        default: true
      enable_coverage:
        description: 'üìä Code Coverage aktivieren (ben√∂tigt JaCoCo)'
        type: boolean
        default: false
      enable_duplications:
        description: 'üîÑ Output'
        type: boolean
        default: false

env:
  JAVA_VERSION: '17'

jobs:
  sonarqube-analysis:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # F√ºr bessere SonarQube Analyse

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          
          restore-keys: ${{ runner.os }}-sonar

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate Contract Code
        run: |
          echo "üìù Generating FishIT Contract from schema..."
          ./gradlew :shared:contract:generateFishitContract
          echo "‚úÖ Contract generation complete"

      # --- Dynamische Source-Pfade basierend auf Inputs ---
      - name: Build Source Paths
        id: sources
        run: |
          SOURCES=""
          
          # Bei push/PR: alle Module analysieren
          # Bei workflow_dispatch: basierend auf Inputs
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            SOURCES="androidApp/src/main/java,shared/contract/src/commonMain/kotlin,shared/contract/src/generated/kotlin,shared/engine/src/commonMain/kotlin,tools/codegen-contract/src/main/kotlin"
          else
            if [[ "${{ inputs.analyze_android }}" == "true" ]]; then
              SOURCES="androidApp/src/main/java"
            fi
            if [[ "${{ inputs.analyze_contract }}" == "true" ]]; then
              [ -n "$SOURCES" ] && SOURCES="$SOURCES,"
              SOURCES="${SOURCES}shared/contract/src/commonMain/kotlin,shared/contract/src/generated/kotlin"
            fi
            if [[ "${{ inputs.analyze_engine }}" == "true" ]]; then
              [ -n "$SOURCES" ] && SOURCES="$SOURCES,"
              SOURCES="${SOURCES}shared/engine/src/commonMain/kotlin"
            fi
            if [[ "${{ inputs.analyze_codegen }}" == "true" ]]; then
              [ -n "$SOURCES" ] && SOURCES="$SOURCES,"
              SOURCES="${SOURCES}tools/codegen-contract/src/main/kotlin"
            fi
          fi
          
          echo "SONAR_SOURCES=$SOURCES" >> $GITHUB_OUTPUT
          echo "üìÅ Sources to analyze: $SOURCES"

      # --- Optional: Tests mit Coverage ---
      - name: Run Tests with Coverage
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.enable_coverage == true }}
        continue-on-error: true
        run: |
          echo "üß™ Running tests..."
          ./gradlew test --continue || true

      # --- SonarQube Analyse ---
      - name: Build and Analyze with SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "üîç Starting SonarQube Analysis..."
          echo "üìÅ Analyzing sources: ${{ steps.sources.outputs.SONAR_SOURCES }}"
          
          # Argumente als Array f√ºr korrekte √úbergabe an Gradle
          GRADLE_ARGS=(
            "-Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}"
            "-Dsonar.token=${{ secrets.SONAR_TOKEN }}"
            "-Dsonar.organization=${{ github.repository_owner }}"
          )
          
          # Dynamische Sources √ºberschreiben die build.gradle.kts Defaults
          if [[ -n "${{ steps.sources.outputs.SONAR_SOURCES }}" ]]; then
            GRADLE_ARGS+=("-Dsonar.sources=${{ steps.sources.outputs.SONAR_SOURCES }}")
          fi
          
          # Coverage-Pfade (wenn aktiviert)
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.enable_coverage }}" == "true" ]]; then
            GRADLE_ARGS+=("-Dsonar.coverage.jacoco.xmlReportPaths=**/build/reports/jacoco/**/*.xml")
          fi
          
          # Duplikaterkennung deaktivieren (wenn gew√ºnscht)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.enable_duplications }}" == "false" ]]; then
            GRADLE_ARGS+=("-Dsonar.cpd.exclusions=**/*")
          fi
          
          # Verbose Mode
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.verbose_mode }}" == "true" ]]; then
            GRADLE_ARGS+=("-Dsonar.verbose=true")
          fi
          
          echo "üîß Gradle Arguments: ${GRADLE_ARGS[*]}"
          
          # Korrekte √úbergabe als separate Argumente (behebt den String-to-Collection Cast-Fehler)
          ./gradlew sonar "${GRADLE_ARGS[@]}"

      - name: Generate Analysis Summary
        if: always()
        run: |
          echo "=============================================="
          echo "üîç SONARQUBE ANALYSIS SUMMARY"
          echo "=============================================="
          echo ""
          echo "üìÖ Timestamp: $(date)"
          echo "üìÅ Repository: ${{ github.repository }}"
          echo "üîÄ Event: ${{ github.event_name }}"
          echo "üîñ Ref: ${{ github.ref }}"
          echo ""
          echo "üìä Configuration:"
          echo "   Sources: ${{ steps.sources.outputs.SONAR_SOURCES }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo ""
            echo "üìã Input Settings:"
            echo "   Android App: ${{ inputs.analyze_android }}"
            echo "   Contract Module: ${{ inputs.analyze_contract }}"
            echo "   Engine Module: ${{ inputs.analyze_engine }}"
            echo "   Codegen Tools: ${{ inputs.analyze_codegen }}"
            echo "   Coverage: ${{ inputs.enable_coverage }}"
            echo "   Duplications: ${{ inputs.enable_duplications }}"
            echo "   Verbose: ${{ inputs.verbose_mode }}"
          fi
          echo "=============================================="