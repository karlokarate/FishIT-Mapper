name: Agent PR Ready

# Dieser Workflow setzt einen PR automatisch von Draft auf "Ready for Review"
# nachdem ein Agent erfolgreich seine Arbeit abgeschlossen hat

on:
  workflow_run:
    workflows: ["GitHub Copilot Agent", "OpenAI Codex Agent"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR-Nummer'
        required: true
        type: number
      force_ready:
        description: 'PR auf Ready setzen erzwingen'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  check-and-update-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Get PR from Workflow Run
        id: get_pr
        uses: actions/github-script@v7
        if: github.event_name == 'workflow_run'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Finde PRs die mit dem Workflow-Run verbunden sind
            const workflowRun = context.payload.workflow_run;
            
            if (!workflowRun) {
              console.log('Kein Workflow-Run gefunden');
              return null;
            }
            
            // Hole PRs f√ºr den Branch
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${workflowRun.head_branch}`,
              state: 'open'
            });
            
            if (pulls.data.length === 0) {
              console.log('Keine offenen PRs f√ºr Branch gefunden:', workflowRun.head_branch);
              return null;
            }
            
            const pr = pulls.data[0];
            core.setOutput('pr_number', pr.number);
            core.setOutput('is_draft', pr.draft);
            core.setOutput('workflow_success', workflowRun.conclusion === 'success');
            
            return pr;
      
      - name: Set PR Number from Input
        id: pr_number
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ steps.get_pr.outputs.pr_number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Skip if no PR found
        if: steps.pr_number.outputs.pr_number == ''
        run: |
          echo "Kein PR gefunden, √ºberspringe Workflow"
          exit 0
      
      - name: Get PR Details
        id: pr_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ steps.pr_number.outputs.pr_number }}')
            });
            
            core.setOutput('is_draft', pr.data.draft);
            core.setOutput('title', pr.data.title);
            core.setOutput('state', pr.data.state);
            
            return pr.data;
      
      - name: Check if PR should be marked as Ready
        id: should_mark_ready
        run: |
          IS_DRAFT="${{ steps.pr_details.outputs.is_draft }}"
          WORKFLOW_SUCCESS="${{ steps.get_pr.outputs.workflow_success }}"
          FORCE_READY="${{ inputs.force_ready }}"
          
          if [ "$IS_DRAFT" == "true" ] && ([ "$WORKFLOW_SUCCESS" == "true" ] || [ "$FORCE_READY" == "true" ]); then
            echo "should_mark=true" >> $GITHUB_OUTPUT
            echo "PR ist Draft und Agent-Arbeit war erfolgreich - markiere als Ready"
          else
            echo "should_mark=false" >> $GITHUB_OUTPUT
            echo "Bedingungen f√ºr Ready nicht erf√ºllt (Draft: $IS_DRAFT, Success: $WORKFLOW_SUCCESS, Force: $FORCE_READY)"
          fi
      
      - name: Mark PR as Ready for Review
        if: steps.should_mark_ready.outputs.should_mark == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ steps.pr_number.outputs.pr_number }}'),
              draft: false
            });
            
            console.log('PR wurde als "Ready for Review" markiert');
      
      - name: Update Status Check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ steps.pr_number.outputs.pr_number }}')
            });
            
            const status = '${{ steps.should_mark_ready.outputs.should_mark }}' === 'true' ? 'success' : 'pending';
            const description = '${{ steps.should_mark_ready.outputs.should_mark }}' === 'true' 
              ? 'PR ist bereit f√ºr Review' 
              : 'Agent-Arbeit l√§uft noch oder PR ist bereits Ready';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.data.head.sha,
              state: status,
              context: 'Agent PR Ready',
              description: description
            });
      
      - name: Post Update Comment
        if: steps.should_mark_ready.outputs.should_mark == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ‚úÖ PR ist bereit f√ºr Review
            
            Der Agent hat seine Arbeit erfolgreich abgeschlossen!
            
            ### Status:
            - ‚úÖ Agent-Aufgaben abgeschlossen
            - ‚úÖ PR von Draft auf "Ready for Review" gesetzt
            - üîç Bereit f√ºr manuelles Review
            
            ### N√§chste Schritte:
            1. Pr√ºfe die √Ñnderungen durch den Agent
            2. F√ºhre einen manuellen Review durch
            3. Merge wenn alles in Ordnung ist
            
            ---
            *Automatisch aktualisiert durch Agent PR Ready Workflow*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.pr_number.outputs.pr_number }}'),
              body: comment
            });
      
      - name: Update Labels
        if: steps.should_mark_ready.outputs.should_mark == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Entferne "review:requested" Label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt('${{ steps.pr_number.outputs.pr_number }}'),
                  name: 'review:requested'
                });
                console.log('Label "review:requested" entfernt');
              } catch (error) {
                console.log('Label "review:requested" nicht gefunden oder konnte nicht entfernt werden:', error.message);
              }
              
              // F√ºge "ready-for-review" Label hinzu
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt('${{ steps.pr_number.outputs.pr_number }}'),
                labels: ['ready-for-review']
              });
              console.log('Label "ready-for-review" hinzugef√ºgt');
            } catch (error) {
              console.error('Fehler beim Label-Update:', error.message);
              // Workflow nicht fehlschlagen lassen, nur Fehler loggen
            }
