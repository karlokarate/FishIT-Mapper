name: GitHub Actions Orchestrator

# The orchestrator runs on multiple triggers to ensure timely state transitions
on:
  issues:
    types: [labeled, reopened, edited, opened]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [labeled, synchronize, opened]
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to process'
        required: false
        type: number
      pr_number:
        description: 'Specific PR number to process'
        required: false
        type: number
      setup_labels:
        description: 'Only setup labels without processing'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  checks: read
  statuses: read

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    outputs:
      labels_created: ${{ steps.create_labels.outputs.created }}

    steps:
      - name: Setup Orchestrator Labels
        id: create_labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = [
              { name: 'orchestrator:enabled', color: '0e8a16', description: 'Aktiviert den Copilot Orchestrator' },
              { name: 'orchestrator:run', color: '1d76db', description: 'Startet die automatische Verarbeitung' },
              { name: 'state:queued', color: 'd4c5f9', description: 'Wartet auf Verarbeitung' },
              { name: 'state:running', color: 'fbca04', description: 'Task wird bearbeitet' },
              { name: 'state:needs-review', color: '0075ca', description: 'Wartet auf Review' },
              { name: 'state:fixing', color: 'd93f0b', description: 'Review Findings werden behoben' },
              { name: 'state:passed', color: '0e8a16', description: 'Review approved' },
              { name: 'state:merged', color: '6f42c1', description: 'PR gemerged' },
              { name: 'state:blocked', color: 'b60205', description: 'Workflow blockiert' },
              { name: 'status:completed', color: '0e8a16', description: 'Alle Tasks abgeschlossen' }
            ];

            let createdCount = 0;
            let existingCount = 0;

            console.log('ðŸ·ï¸  Setting up Orchestrator Labels...');

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
                console.log(`âœ“ Label "${label.name}" already exists`);
                existingCount++;
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`âœ… Created label "${label.name}"`);
                  createdCount++;
                } else {
                  console.log(`âš ï¸ Error checking label "${label.name}": ${error.message}`);
                }
              }
            }

            console.log(`\nðŸ“Š Summary: ${createdCount} labels created, ${existingCount} already existed`);
            core.setOutput('created', createdCount > 0 ? 'true' : 'false');

  orchestrate:
    runs-on: ubuntu-latest
    needs: setup-labels
    if: github.event.inputs.setup_labels != 'true'
    outputs:
      committed: ${{ steps.commit.outputs.committed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Orchestrator Enabled
        id: check_enabled
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            if (fs.existsSync('codex/ORCHESTRATOR_ENABLED')) {
              console.log('âœ… Orchestrator enabled via file flag');
              core.setOutput('enabled', 'true');
              return true;
            }

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'orchestrator:enabled',
              per_page: 1
            });

            if (issues.data.length > 0) {
              console.log('âœ… Orchestrator enabled via label on issue/PR');
              core.setOutput('enabled', 'true');
              return true;
            }

            console.log('â„¹ï¸  Orchestrator not enabled');
            core.setOutput('enabled', 'false');
            return false;

      - name: Skip if not enabled
        if: steps.check_enabled.outputs.enabled != 'true'
        run: |
          echo "Orchestrator is not enabled. Skipping."
          echo "To enable: add 'orchestrator:enabled' label to an issue or PR"
          exit 0

      - name: Determine Target
        id: target
        run: |
          if [ -n "${{ github.event.inputs.issue_number }}" ]; then
            echo "target_type=issue" >> $GITHUB_OUTPUT
            echo "target_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.pr_number }}" ]; then
            echo "target_type=pr" >> $GITHUB_OUTPUT
            echo "target_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "target_type=issue" >> $GITHUB_OUTPUT
            echo "target_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "target_type=pr" >> $GITHUB_OUTPUT
            echo "target_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "target_type=auto" >> $GITHUB_OUTPUT
            echo "target_number=" >> $GITHUB_OUTPUT
          fi

      - name: Auto-Label Target for Orchestrator
        id: auto_label
        if: steps.check_enabled.outputs.enabled == 'true' && steps.target.outputs.target_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const targetType = '${{ steps.target.outputs.target_type }}';
            const targetNumber = parseInt('${{ steps.target.outputs.target_number }}');

            if (!targetNumber) {
              console.log('â„¹ï¸  No specific target, skipping auto-labeling');
              return;
            }

            console.log(`ðŸŽ¯ Auto-labeling ${targetType} #${targetNumber}...`);

            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: targetNumber
              });

              const currentLabels = issue.labels.map(l => l.name);
              console.log(`Current labels: ${currentLabels.join(', ') || 'none'}`);

              const hasOrchestratorEnabled = currentLabels.includes('orchestrator:enabled');
              const hasOrchestratorRun = currentLabels.includes('orchestrator:run');
              const hasStateLabel = currentLabels.some(l => l.startsWith('state:'));

              const labelsToAdd = [];

              if (!hasOrchestratorEnabled) {
                labelsToAdd.push('orchestrator:enabled');
              }
              if (!hasOrchestratorRun) {
                labelsToAdd.push('orchestrator:run');
              }
              if (!hasStateLabel) {
                labelsToAdd.push('state:queued');
              }

              if (labelsToAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: targetNumber,
                  labels: labelsToAdd
                });
                console.log(`âœ… Added labels: ${labelsToAdd.join(', ')}`);
                core.setOutput('labels_added', labelsToAdd.join(','));
              } else {
                console.log('â„¹ï¸  Target already has all required orchestrator labels');
                core.setOutput('labels_added', '');
              }
            } catch (error) {
              console.log(`âš ï¸ Error auto-labeling: ${error.message}`);
              core.setOutput('labels_added', '');
            }

      - name: Run Orchestrator Transition
        id: transition
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ðŸš€ Running orchestrator transition script..."

          CMD="node scripts/orchestrator/transition.mjs"

          if [ "${{ steps.target.outputs.target_type }}" == "issue" ]; then
            CMD="$CMD --issue ${{ steps.target.outputs.target_number }}"
          elif [ "${{ steps.target.outputs.target_type }}" == "pr" ]; then
            CMD="$CMD --pr ${{ steps.target.outputs.target_number }}"
          fi

          $CMD

          echo "âœ… Transition script completed"

      - name: Commit Checkpoint Updates
        id: commit
        run: |
          git config --global user.name "GitHub Actions Orchestrator"
          git config --global user.email "orchestrator@github.com"

          if [[ -n $(git status -s codex/) ]]; then
            git add codex/
            git commit -m "ðŸ¤– Orchestrator: Update checkpoint [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "âœ… Checkpoint files committed and pushed"
          else
            echo "committed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No checkpoint changes to commit"
          fi

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ¤– Orchestrator Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Type:** ${{ steps.target.outputs.target_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Number:** ${{ steps.target.outputs.target_number || 'auto-discover' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Labels Added:** ${{ steps.auto_label.outputs.labels_added || 'none' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Checkpoint Updated:** ${{ steps.commit.outputs.committed || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Latest Checkpoint:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 codex/CHECKPOINT.md >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No checkpoint file found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  verify-build:
    runs-on: ubuntu-latest
    needs: orchestrate
    if: needs.orchestrate.outputs.committed == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Generate Contract
        run: |
          echo "Generating FishIT contract..."
          ./gradlew :shared:contract:generateFishitContract --no-daemon

      - name: Compile Debug Kotlin
        run: |
          echo "Compiling Android app (debug)..."
          ./gradlew :androidApp:compileDebugKotlin --no-daemon

      - name: Report Build Status
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildStatus = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = buildStatus === 'success'
              ? 'Build verification passed'
              : 'Build verification failed';

            console.log(`Build status: ${buildStatus}`);
            console.log(`Description: ${description}`);